<script>
  // HUD & nav updates (unchanged)
  function updateBitsDisplay() {
    const ud = JSON.parse(localStorage.getItem("userData")) || {};
    const u  = localStorage.getItem("profileUsername");
    if (ud[u]) document.getElementById("bitCountTop").innerText = ud[u].bits || 0;
  }
  function updateNavLinks() {
    const u = localStorage.getItem("profileUsername");
    document.getElementById("loginLink").style.display  = u ? "none" : "inline";
    document.getElementById("logoutLink").style.display = u ? "inline" : "none";
    document.getElementById("adminBtn").style.display   = (u === "Nova") ? "inline" : "none";
  }
  function logout() {
    localStorage.removeItem("profileUsername");
    window.location.href = "login.html";
  }

  // 1) Fetch all game folders under 'gamesfolder' on GitHub
  async function loadGames() {
    const apiUrl = "https://api.github.com/repos/NovasGame1/pixelgame/contents/gamesfolder?ref=main";
    const container = document.getElementById("gamesContainer");
    container.innerHTML = ""; 

    try {
      const res  = await fetch(apiUrl);
      const dirs = await res.json();

      for (const dir of dirs) {
        if (dir.type !== "dir") continue;

        // 2) Get the JSON file inside each folder
        const folderRes = await fetch(dir.url);
        const files     = await folderRes.json();
        const jsonFile  = files.find(f => f.name.endsWith(".json"));
        if (!jsonFile) continue;

        // 3) Download the JSON to read its metadata
        const metaRes = await fetch(jsonFile.download_url);
        const game    = await metaRes.json();

        // 4) Build the retro-Roblox card
        const card = document.createElement("div");
        card.className = "game-card";
        card.innerHTML = `
          <div class="game-thumb"></div>
          <div class="game-info">
            <h3>${game.name}</h3>
            <p>${game.description}</p>
            <button>Play</button>
          </div>`;

        // 5) Wire up Play button to protocol first, then fallback
        card.querySelector("button").onclick = () => {
          // URL-encode the raw GitHub URL to our JSON
          const rawUrl = encodeURIComponent(jsonFile.download_url);

          // 1️⃣ Attempt to open in desktop PixelGame Player
          window.location.href = `pixelgame://load?level=${rawUrl}`;

          // 2️⃣ Fallback to web player after 500ms
          setTimeout(() => {
            window.location.href = `player.html?level=gamesfolder/${dir.name}/${jsonFile.name}`;
          }, 500);
        };

        container.appendChild(card);
      }
    } catch (err) {
      console.error("Failed to load games:", err);
      container.innerHTML = "<p style='color:red;'>Unable to load games.</p>";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    updateNavLinks();
    updateBitsDisplay();
    loadGames();
  });
</script>
