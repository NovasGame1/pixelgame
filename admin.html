<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PixelGame ‚Äì Admin Panel</title>

  <!-- Logo -->
  <link rel="icon" href="assets/images/logo.png" type="image/png">
  <link rel="shortcut icon" href="assets/images/logo.png" type="image/png">
  <link rel="stylesheet" href="style.css">

  <style>
    body.light { background: #f2f2f2; color: #333; }
    body.dark  { background: #222;   color: #eee; }
    input, button, select, textarea {
      margin: 4px 0; padding: 6px; font-size: 14px;
    }
    .section-box {
      background: #fff; border: 1px solid #aaa;
      padding: 15px; margin-bottom: 20px;
    }
    body.dark .section-box { background: #333; border-color: #555; }
    .user-card {
      border:1px solid #ccc; background:#fff;
      padding:15px; margin-bottom:15px;
    }
    body.dark .user-card { background:#444; border-color:#666; }
    .admin-controls { display:grid; gap:6px; margin-top:10px; }
    .admin-controls div { display:flex; gap:10px; align-items:center; }
    .admin-controls label { width:120px; font-weight:bold; }
    .flags { font-size:0.9em; color:#666; margin-top:5px; }
    body.dark .flags { color:#999; }
    #auditLog, #loginHistory, #flagsList {
      background:#fff; border:1px solid #aaa;
      padding:10px; max-height:150px; overflow-y:auto;
      margin-top:10px;
    }
    body.dark #auditLog,
    body.dark #loginHistory,
    body.dark #flagsList { background:#333; border-color:#555; }
  </style>
</head>
<body class="light">
  <div id="bitsDisplay">Bits: <span id="bitCountTop">0</span></div>
  <div class="page-wrapper">
    <header>
      <a href="index.html" class="site-logo-link">
        <img src="assets/images/logo.png" class="site-logo" alt="PixelGame">
      </a>
      <nav>
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="profile.html">Profile</a>
        <a href="people.html">People</a>
        <a href="shop.html">Shop</a>
        <a href="admin.html" id="adminBtn" style="display:none;">Admin Panel</a>
        <a href="login.html" id="loginLink">Login</a>
        <a href="#" id="logoutLink" style="display:none;" onclick="logout()">Logout</a>
      </nav>
    </header>

    <main>
      <h2>Admin Panel ‚Äì Owner Control</h2>

      <!-- Broadcast to All -->
      <div class="section-box">
        <h3>üì£ Broadcast Message</h3>
        <input type="text" id="broadcastInput" placeholder="Your broadcast‚Ä¶">
        <button onclick="broadcastAll()">Send to All</button>
      </div>

      <!-- Targeted Alert -->
      <div class="section-box">
        <h3>üéØ Targeted Alert</h3>
        <select id="alertUserSelect"></select>
        <input type="text" id="alertInput" placeholder="Alert message‚Ä¶">
        <button onclick="sendAlert()">Send Alert</button>
      </div>

      <!-- Maintenance Mode -->
      <div class="section-box">
        <h3>üîß Maintenance Mode</h3>
        <button id="maintenanceBtn" onclick="toggleMaintenance()">Toggle Maintenance</button>
      </div>

      <!-- Data Import/Export -->
      <div class="section-box">
        <h3>üíæ Data Import/Export</h3>
        <button onclick="exportUsers()">Export All Users</button>
        <input type="file" id="importFile" accept=".json" onchange="importUsers(event)">
      </div>

      <!-- Feature Flags -->
      <div class="section-box">
        <h3>üö© Feature Flags</h3>
        <input type="text" id="flagName" placeholder="Flag name‚Ä¶">
        <button onclick="toggleFeatureFlag()">Toggle Flag</button>
        <div id="flagsList">Loading flags‚Ä¶</div>
      </div>

      <!-- Theme Switcher -->
      <div class="section-box">
        <h3>üé® Theme</h3>
        <button onclick="switchTheme()">Switch Theme</button>
      </div>

      <!-- Homepage Content Editor -->
      <div class="section-box">
        <h3>üè† Homepage Content</h3>
        <input type="text" id="homeTitle" placeholder="Banner Title‚Ä¶">
        <textarea id="homeDesc" rows="3" placeholder="Banner Description‚Ä¶"></textarea>
        <button onclick="saveHomepageContent()">Save Content</button>
      </div>

      <!-- Bits Giveaway -->
      <div class="section-box">
        <h3>üí∞ Bits Giveaway</h3>
        <input type="number" id="giveawayAmount" placeholder="Bits amount‚Ä¶">
        <button onclick="giveBitsToAll()">Give to All</button>
      </div>

      <!-- Danger Zone: Clear Data -->
      <div class="section-box">
        <h3>‚ö†Ô∏è Danger Zone</h3>
        <button onclick="clearAllData()">Clear All User Data</button>
      </div>

      <!-- Search & User Management -->
      <input type="text" id="searchBar"
             placeholder="Search users‚Ä¶" style="width:100%;padding:10px;margin:15px 0;"
             oninput="renderUserList()">
      <div id="adminUsers">Loading users‚Ä¶</div>

      <!-- Audit Log -->
      <div class="section-box">
        <h3>üìú Audit Log</h3>
        <div id="auditLog">Loading logs‚Ä¶</div>
      </div>
    </main>

    <footer>¬© 2025 PixelGame.</footer>
  </div>

  <script>
    const OWNER = "Nova";

    // Basic UI updates
    function logout() {
      localStorage.removeItem("profileUsername");
      localStorage.removeItem("profileBio");
      updateNavLinks();
      window.location.href = "login.html";
    }
    function updateNavLinks() {
      const me = localStorage.getItem("profileUsername");
      document.getElementById("loginLink").style.display = me ? "none" : "inline";
      document.getElementById("logoutLink").style.display = me ? "inline" : "none";
      document.getElementById("adminBtn").style.display = (me === OWNER) ? "inline" : "none";
    }
    function updateBitsDisplay() {
      const ud = JSON.parse(localStorage.getItem("userData"))||{};
      const me = localStorage.getItem("profileUsername");
      if(ud[me]) document.getElementById("bitCountTop").innerText = ud[me].bits||0;
    }

    // Audit logging
    function logAction(action,target,details="") {
      const logs = JSON.parse(localStorage.getItem("adminAuditLog"))||[];
      logs.unshift({ time:new Date().toLocaleString(), admin:OWNER, action, target, details });
      localStorage.setItem("adminAuditLog", JSON.stringify(logs));
      renderAuditLog();
    }
    function renderAuditLog(){
      const logs=JSON.parse(localStorage.getItem("adminAuditLog"))||[];
      document.getElementById("auditLog").innerHTML =
        logs.slice(0,50).map(l=>`[${l.time}] ${l.admin} ${l.action} ${l.target} ${l.details}`)
             .join("<br>");
    }

    // Broadcast
    function broadcastAll(){
      const msg=document.getElementById("broadcastInput").value.trim();
      if(!msg) return alert("Type a message.");
      localStorage.setItem("broadcastMessage", msg);
      logAction("Broadcasted","ALL",msg);
      alert("Broadcast queued.");
    }

    // Targeted alerts
    function sendAlert(){
      const user=document.getElementById("alertUserSelect").value;
      const msg =document.getElementById("alertInput").value.trim();
      if(!user||!msg) return alert("Select user & message.");
      const alerts=JSON.parse(localStorage.getItem("userAlerts"))||{};
      alerts[user]=alerts[user]||[];
      alerts[user].push({by:OWNER,time:new Date().toLocaleString(),msg});
      localStorage.setItem("userAlerts",JSON.stringify(alerts));
      logAction("Alerted",user,msg);
      alert("Alert sent.");
    }

    // Maintenance Mode
    function toggleMaintenance(){
      const m = JSON.parse(localStorage.getItem("maintenanceMode"))||false;
      localStorage.setItem("maintenanceMode", JSON.stringify(!m));
      document.getElementById("maintenanceBtn").innerText = !m ? "Disable Maintenance" : "Enable Maintenance";
      logAction(!m?"Enabled Maintenance":"Disabled Maintenance","ALL");
    }

    // Data Export/Import
    function exportUsers(){
      const data = localStorage.getItem("userData") || "{}";
      const blob = new Blob([data],{type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download="userData.json"; a.click();
      URL.revokeObjectURL(url);
      logAction("Exported","userData");
    }
    function importUsers(evt){
      const file=evt.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=e=>{
        try {
          const imported=JSON.parse(e.target.result);
          localStorage.setItem("userData",JSON.stringify(imported));
          logAction("Imported","userData");
          renderUserList();
          alert("Import successful.");
        } catch {
          alert("Invalid JSON.");
        }
      };
      reader.readAsText(file);
    }

    // Feature Flags
    function toggleFeatureFlag(){
      const name=document.getElementById("flagName").value.trim();
      if(!name) return alert("Flag name?");
      const flags=JSON.parse(localStorage.getItem("featureFlags"))||{};
      flags[name]=!flags[name];
      localStorage.setItem("featureFlags",JSON.stringify(flags));
      logAction("ToggledFlag",name,flags[name]);
      renderFlags();
    }
    function renderFlags(){
      const flags=JSON.parse(localStorage.getItem("featureFlags"))||{};
      const out=Object.entries(flags).map(([k,v])=>`${k}: ${v}`).join("<br>");
      document.getElementById("flagsList").innerHTML = out||"<i>No flags set</i>";
    }

    // Theme switcher
    function switchTheme(){
      const cur=localStorage.getItem("theme")||"light";
      const nxt=cur==="light"?"dark":"light";
      document.body.classList.replace(cur,nxt);
      localStorage.setItem("theme",nxt);
      logAction("Theme","Set",nxt);
    }
    function initTheme(){
      const t=localStorage.getItem("theme")||"light";
      document.body.classList.add(t);
    }

    // Homepage content
    function saveHomepageContent(){
      const t=document.getElementById("homeTitle").value;
      const d=document.getElementById("homeDesc").value;
      localStorage.setItem("homeTitle",t);
      localStorage.setItem("homeDesc",d);
      logAction("Edited","Homepage",`${t} | ${d}`);
      alert("Homepage updated.");
    }
    function loadHomepageContent(){
      document.getElementById("homeTitle").value = localStorage.getItem("homeTitle")||"";
      document.getElementById("homeDesc").value  = localStorage.getItem("homeDesc")||"";
    }

    // Bits Giveaway
    function giveBitsToAll(){
      const amt = parseInt(document.getElementById("giveawayAmount").value);
      if(isNaN(amt)) return alert("Enter a number");
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      for(const u in ud) ud[u].bits = (ud[u].bits||0) + amt;
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction("GaveBits","ALL",amt);
      updateBitsDisplay();
      renderUserList();
      alert(`Gave ${amt} Bits to everyone.`);
    }

    // Clear all data
    function clearAllData(){
      if(confirm("Delete ALL userData?")) {
        localStorage.removeItem("userData");
        logAction("Cleared","AllUserData");
        renderUserList();
        alert("All user data cleared.");
      }
    }

    // User actions
    function togglePassword(username){
      const f=document.getElementById(`newPass-${username}`);
      f.type = f.type==="password"?"text":"password";
    }
    function toggleAdmin(username){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      ud[username].isAdmin = !ud[username].isAdmin;
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction(ud[username].isAdmin?"Promoted":"Demoted",username);
      renderUserList();
    }
    function toggleLock(username){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const u=ud[username];
      if(!u.isLocked){
        const r=prompt(`Reason to lock ${username}:` )||"No reason";
        const d=prompt("Minutes to lock (blank=perm):");
        u.isLocked=true; u.lockReason=r;
        if(d&&!isNaN(d)) u.lockExpires=Date.now()+parseInt(d)*60000;
        alert(`${username} locked.`);
        logAction("Locked",username,r);
      } else {
        u.isLocked=false;delete u.lockReason;delete u.lockExpires;
        alert(`${username} unlocked.`); logAction("Unlocked",username);
      }
      localStorage.setItem("userData",JSON.stringify(ud));
      renderUserList();
    }
    function toggleBan(username){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const u=ud[username];
      if(!u.isBanned){
        const r=prompt(`Ban reason for ${username}:`)||"No reason";
        const d=prompt("Minutes to ban (blank=perm):");
        u.isBanned=true; u.banReason=r;
        if(d&&!isNaN(d)) u.banExpires=Date.now()+parseInt(d)*60000;
        alert(`${username} banned.`); logAction("Banned",username,r);
      } else {
        u.isBanned=false; delete u.banReason; delete u.banExpires;
        alert(`${username} unbanned.`); logAction("Unbanned",username);
      }
      localStorage.setItem("userData",JSON.stringify(ud));
      renderUserList();
    }
    function resetStats(username){
      if(!confirm(`Reset stats for ${username}?`)) return;
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const u=ud[username];
      u.bits=0; u.bio=""; u.friends=[]; u.shirtsEquipped=null; u.pantsEquipped=null;
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction("ResetStats",username);
      renderUserList();
    }
    function applyChanges(oldUsername){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const newName=document.getElementById(`newName-${oldUsername}`).value.trim();
      if(newName!==oldUsername && ud[newName]){ alert("Name taken"); return; }
      const u=ud[oldUsername];
      const newBio=document.getElementById(`newBio-${oldUsername}`).value;
      const newBits=parseInt(document.getElementById(`newBits-${oldUsername}`).value)||0;
      const newPass=document.getElementById(`newPass-${oldUsername}`).value;
      if(newPass.length>0 && newPass.length<6){ alert("Pw ‚â•6 chars"); return; }
      delete ud[oldUsername];
      u.username=newName; u.bio=newBio; u.bits=newBits; u.password=newPass;
      ud[newName]=u;
      for(const x in ud){
        const f=ud[x].friends||[];
        const i=f.indexOf(oldUsername);
        if(i!==-1){ f[i]=newName; ud[x].friends=f; }
      }
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction("Edited",oldUsername,`‚Üí${newName}`);
      renderUserList();
    }
    function deleteUser(username){
      if(!confirm(`Delete ${username}?`)) return;
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      delete ud[username];
      for(const x in ud){
        ud[x].friends=(ud[x].friends||[]).filter(f=>f!==username);
      }
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction("Deleted",username);
      renderUserList();
    }

    // Render users & init dropdown
    function renderUserList(){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const s=document.getElementById("searchBar").value.toLowerCase();
      const ct=document.getElementById("adminUsers");
      const sel=document.getElementById("alertUserSelect");
      ct.innerHTML=""; sel.innerHTML="<option value=''>Select‚Ä¶</option>";
      const now=Date.now();
      for(const username in ud){
        if(!username.toLowerCase().includes(s)) continue;
        const u=ud[username];
        // auto-unlock/unban
        if(u.isLocked && u.lockExpires && now>u.lockExpires){ u.isLocked=false; delete u.lockReason; delete u.lockExpires; }
        if(u.isBanned && u.banExpires && now>u.banExpires){ u.isBanned=false; delete u.banReason; delete u.banExpires; }
        // alert dropdown
        const opt=document.createElement("option");
        opt.value=username; opt.innerText=username;
        sel.appendChild(opt);
        // flags
        let flags=[];
        flags.push(u.isAdmin?"Admin":"User");
        flags.push(u.isLocked?"Locked":"Unlocked");
        if(u.isLocked&&u.lockExpires) flags.push(`${((u.lockExpires-now)/60000|0)}m lock`);
        flags.push(u.isBanned?"Banned":"Active");
        if(u.isBanned&&u.banExpires) flags.push(`${((u.banExpires-now)/60000|0)}m ban`);
        // tags
        if(u.tags?.length) flags.push("Tags:"+u.tags.join(","));
        ct.innerHTML+=`
          <div class="user-card">
            <strong>${username}</strong>
            <div class="flags">${flags.join(" | ")}</div>
            ${u.isBanned?`<div style="color:red"><b>Reason:</b> ${u.banReason}</div>`:""}
            ${u.isLocked?`<div style="color:orange"><b>Lock Reason:</b> ${u.lockReason}</div>`:""}
            <div class="admin-controls">
              <div><label>Username:</label><input type="text" id="newName-${username}" value="${username}"></div>
              <div><label>Bio:</label><input type="text" id="newBio-${username}" value="${u.bio||""}"></div>
              <div><label>Bits:</label><input type="number" id="newBits-${username}" value="${u.bits||0}"></div>
              <div>
                <label>Password:</label>
                <input type="password" id="newPass-${username}" value="${u.password||""}">
                <button onclick="togglePassword('${username}')">üëÅÔ∏è</button>
              </div>
              <div><label>Tags:</label>
                <input type="text" id="newTags-${username}" placeholder="a,b,c" value="${u.tags?.join(",")||""}">
              </div>
              <div>
                <button onclick="toggleAdmin('${username}')">${u.isAdmin?"Demote":"Promote"} Admin</button>
                <button onclick="toggleLock('${username}')">${u.isLocked?"Unlock":"Lock"} Account</button>
                <button onclick="toggleBan('${username}')">${u.isBanned?"Unban":"Ban"} User</button>
                <button onclick="resetStats('${username}')">Reset Stats</button>
                <button onclick="applyChanges('${username}')">Save</button>
                <button onclick="deleteUser('${username}')">Delete</button>
              </div>
            </div>
          </div>`;
      }
    }

    document.addEventListener("DOMContentLoaded",()=>{
      // Owner-only
      const me = localStorage.getItem("profileUsername");
      if(me!==OWNER){
        document.body.innerHTML = "<div style='padding:30px;'><h2>Access Denied</h2><p>Owner only.</p></div>";
        return;
      }
      updateNavLinks();
      updateBitsDisplay();
      initTheme();
      renderFlags();
      loadHomepageContent();
      renderUserList();
      renderAuditLog();
    });
  </script>
</body>
</html>
