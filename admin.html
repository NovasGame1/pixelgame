<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PixelGame ‚Äì Admin Panel</title>

  <!-- Logo -->
  <link rel="icon" href="assets/images/logo.png" type="image/png">
  <link rel="shortcut icon" href="assets/images/logo.png" type="image/png">
  <link rel="stylesheet" href="style.css">

  <style>
    body { background: #f2f2f2; }
    input, button, select { margin:4px 0; padding:6px; font-size:14px; }
    .section-box { background:#fff; border:1px solid #aaa; padding:15px; margin-bottom:20px; }
    .user-card { border:1px solid #ccc; background:#fff; padding:15px; margin-bottom:15px; }
    .admin-controls { display:grid; gap:6px; margin-top:10px; }
    .admin-controls div { display:flex; gap:10px; align-items:center; }
    .admin-controls label { width:120px; font-weight:bold; }
    .flags { font-size:0.9em; color:#666; margin-top:5px; }
    #auditLog { background:#fff; border:1px solid #aaa; padding:15px; max-height:200px; overflow-y:auto; }
  </style>
</head>
<body>
  <div id="bitsDisplay">Bits: <span id="bitCountTop">0</span></div>
  <div class="page-wrapper">
    <header>
      <a href="index.html" class="site-logo-link">
        <img src="assets/images/logo.png" class="site-logo" alt="PixelGame">
      </a>
      <nav>
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="profile.html">Profile</a>
        <a href="people.html">People</a>
        <a href="shop.html">Shop</a>
        <a href="admin.html" id="adminBtn" style="display:none;">Admin Panel</a>
        <a href="login.html" id="loginLink">Login</a>
        <a href="#" id="logoutLink" style="display:none;" onclick="logout()">Logout</a>
      </nav>
    </header>

    <main>
      <h2>Admin Panel ‚Äì Owner Control</h2>

      <!-- Broadcast to All -->
      <div class="section-box">
        <h3>Broadcast Message</h3>
        <input type="text" id="broadcastInput" placeholder="Your broadcast‚Ä¶">
        <button onclick="broadcastAll()">Send to All</button>
      </div>

      <!-- Targeted Alert -->
      <div class="section-box">
        <h3>Targeted Alert</h3>
        <select id="alertUserSelect"></select>
        <input type="text" id="alertInput" placeholder="Alert message‚Ä¶">
        <button onclick="sendAlert()">Send Alert</button>
      </div>

      <!-- User Management -->
      <input type="text" id="searchBar" placeholder="Search users‚Ä¶" style="width:100%;padding:10px;margin:15px 0;" oninput="renderUserList()">
      <div id="adminUsers">Loading users‚Ä¶</div>

      <!-- Audit Log -->
      <div class="section-box">
        <h3>Audit Log</h3>
        <div id="auditLog">Loading logs‚Ä¶</div>
      </div>
    </main>

    <footer>¬© 2025 PixelGame.</footer>
  </div>

  <script>
    const OWNER = "Nova";
    // Helpers
    function logout() {
      localStorage.removeItem("profileUsername");
      localStorage.removeItem("profileBio");
      updateNavLinks();
      window.location.href = "login.html";
    }
    function updateNavLinks() {
      const me = localStorage.getItem("profileUsername");
      document.getElementById("loginLink").style.display = me ? "none" : "inline";
      document.getElementById("logoutLink").style.display = me ? "inline" : "none";
      document.getElementById("adminBtn").style.display = (me === OWNER) ? "inline" : "none";
    }
    function updateBitsDisplay() {
      const ud = JSON.parse(localStorage.getItem("userData"))||{};
      const me = localStorage.getItem("profileUsername");
      if(ud[me]) document.getElementById("bitCountTop").innerText = ud[me].bits||0;
    }
    function logAction(action, target, details="") {
      const logs = JSON.parse(localStorage.getItem("adminAuditLog"))||[];
      logs.unshift({ time: new Date().toLocaleString(), admin: OWNER, action, target, details });
      localStorage.setItem("adminAuditLog", JSON.stringify(logs));
      renderAuditLog();
    }
    function renderAuditLog(){
      const logs = JSON.parse(localStorage.getItem("adminAuditLog"))||[];
      const c = document.getElementById("auditLog");
      c.innerHTML = logs.slice(0,20).map(l=>`[${l.time}] ${l.admin} ${l.action} ${l.target} ${l.details}`).join("<br>");
    }
    // Broadcast
    function broadcastAll(){
      const msg = document.getElementById("broadcastInput").value.trim();
      if(!msg) return alert("Type a message.");
      localStorage.setItem("broadcastMessage", msg);
      logAction("Broadcasted","ALL", msg);
      alert("Broadcast queued.");
    }
    // Targeted alerts
    function sendAlert(){
      const user = document.getElementById("alertUserSelect").value;
      const msg  = document.getElementById("alertInput").value.trim();
      if(!user||!msg) return alert("Select user & message.");
      const alerts = JSON.parse(localStorage.getItem("userAlerts"))||{};
      alerts[user] = alerts[user]||[];
      alerts[user].push({by:OWNER, time:new Date().toLocaleString(), msg});
      localStorage.setItem("userAlerts", JSON.stringify(alerts));
      logAction("Alerted",user,msg);
      alert("Alert sent.");
    }
    // User utils
    function togglePassword(username){
      const f = document.getElementById(`newPass-${username}`);
      f.type = f.type==="password"?"text":"password";
    }
    function toggleAdmin(username){
      const ud = JSON.parse(localStorage.getItem("userData"))||{};
      ud[username].isAdmin = !ud[username].isAdmin;
      localStorage.setItem("userData", JSON.stringify(ud));
      logAction( ud[username].isAdmin?"Promoted":"Demoted", username );
      renderUserList();
    }
    // Lock (disable login without ban)
    function toggleLock(username){
      const ud = JSON.parse(localStorage.getItem("userData"))||{};
      const u = ud[username];
      if(!u.isLocked){
        const reason = prompt(`Reason to lock ${username}:`)||"No reason";
        let dur = prompt("Minutes to lock (blank=perm):");
        let exp=null; if(dur&&!isNaN(dur)) exp=Date.now()+parseInt(dur)*60000;
        u.isLocked=true; u.lockReason=reason; u.lockExpires=exp;
        alert(`${username} locked.`);
        logAction("Locked",username,reason+ (exp?` until ${new Date(exp).toLocaleString()}`:""));
      } else {
        u.isLocked=false; delete u.lockReason; delete u.lockExpires;
        alert(`${username} unlocked.`);
        logAction("Unlocked",username);
      }
      localStorage.setItem("userData", JSON.stringify(ud));
      renderUserList();
    }
    // Ban (with reason & temp)
    function toggleBan(username){
      const ud = JSON.parse(localStorage.getItem("userData"))||{};
      const u = ud[username];
      if(!u.isBanned){
        const reason = prompt(`Ban reason for ${username}:`)||"No reason";
        let dur = prompt("Minutes to ban (blank=perm):");
        let exp=null; if(dur&&!isNaN(dur)) exp=Date.now()+parseInt(dur)*60000;
        u.isBanned=true; u.banReason=reason; u.banExpires=exp;
        alert(`${username} banned.`);
        logAction("Banned",username,reason+ (exp?` until ${new Date(exp).toLocaleString()}`:""));
      } else {
        u.isBanned=false; delete u.banReason; delete u.banExpires;
        alert(`${username} unbanned.`);
        logAction("Unbanned",username);
      }
      localStorage.setItem("userData", JSON.stringify(ud));
      renderUserList();
    }
    // Reset stats
    function resetStats(username){
      if(!confirm(`Reset all stats for ${username}?`)) return;
      const ud = JSON.parse(localStorage.getItem("userData"))||{};
      const u = ud[username];
      u.bits=0; u.bio=""; u.friends=[]; u.shirtsEquipped=null; u.pantsEquipped=null;
      localStorage.setItem("userData", JSON.stringify(ud));
      logAction("ResetStats",username);
      renderUserList();
    }
    // Delete user
    function deleteUser(username){
      if(!confirm(`Delete ${username}?`)) return;
      const ud = JSON.parse(localStorage.getItem("userData"))||{};
      delete ud[username];
      for(const x in ud) ud[x].friends=(ud[x].friends||[]).filter(f=>f!==username);
      localStorage.setItem("userData", JSON.stringify(ud));
      logAction("Deleted",username);
      renderUserList();
    }

    function renderUserList(){
      const ud = JSON.parse(localStorage.getItem("userData"))||{};
      const s = document.getElementById("searchBar").value.toLowerCase();
      const ct = document.getElementById("adminUsers");
      ct.innerHTML=""; document.getElementById("alertUserSelect").innerHTML="<option value=''>Select‚Ä¶</option>";

      const now=Date.now();
      for(const username in ud){
        if(!username.toLowerCase().includes(s)) continue;
        const u=ud[username];
        // auto-unlock/ban expiration
        if(u.isLocked && u.lockExpires&& now>u.lockExpires) { u.isLocked=false; delete u.lockReason; delete u.lockExpires;}
        if(u.isBanned&& u.banExpires&& now>u.banExpires) { u.isBanned=false; delete u.banReason; delete u.banExpires;}

        // add to alert dropdown
        const opt=document.createElement("option");
        opt.value=username; opt.innerText=username;
        document.getElementById("alertUserSelect").appendChild(opt);

        let flags=[];
        flags.push(u.isAdmin?"Admin":"User");
        flags.push(u.isLocked?"Locked":"Unlocked");
        if(u.isLocked&&u.lockExpires) flags.push(`üîí ${(u.lockExpires-now)/60000|0}m left`);
        flags.push(u.isBanned?"Banned":"Active");
        if(u.isBanned&&u.banExpires) flags.push(`‚è± ${(u.banExpires-now)/60000|0}m left`);

        ct.innerHTML+=`
          <div class="user-card">
            <strong>${username}</strong>
            <div class="flags">${flags.join(" | ")}</div>
            ${u.isBanned?`<div style="color:red"><b>Reason:</b>${u.banReason}</div>`:""}
            ${u.isLocked?`<div style="color:orange"><b>Lock:</b>${u.lockReason}</div>`:""}
            <div class="admin-controls">
              <div><label>Username:</label><input type="text" id="newName-${username}" value="${username}"></div>
              <div><label>Bio:</label><input type="text" id="newBio-${username}" value="${u.bio||""}"></div>
              <div><label>Bits:</label><input type="number" id="newBits-${username}" value="${u.bits||0}"></div>
              <div>
                <label>Password:</label>
                <input type="password" id="newPass-${username}" value="${u.password||""}">
                <button onclick="togglePassword('${username}')">üëÅÔ∏è</button>
              </div>
              <div>
                <button onclick="toggleAdmin('${username}')">${u.isAdmin?"Demote":"Promote"} Admin</button>
                <button onclick="toggleLock('${username}')">${u.isLocked?"Unlock":"Lock"} Account</button>
                <button onclick="toggleBan('${username}')">${u.isBanned?"Unban":"Ban"} User</button>
                <button onclick="resetStats('${username}')">Reset Stats</button>
                <button onclick="applyChanges('${username}')">Save</button>
                <button onclick="deleteUser('${username}')">Delete</button>
              </div>
            </div>
          </div>`;
      }
    }

    // On load
    document.addEventListener("DOMContentLoaded",()=>{
      const me=localStorage.getItem("profileUsername");
      if(me!==OWNER){
        document.body.innerHTML="<div style='padding:30px;'><h2>Access Denied</h2><p>Owner only.</p></div>";
        return;
      }
      updateNavLinks();
      updateBitsDisplay();
      renderUserList();
      renderAuditLog();
    });
  </script>
</body>
</html>
