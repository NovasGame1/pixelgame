<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PixelGame – Admin Panel</title>

  <link rel="icon" href="assets/images/logo.png" type="image/png">
  <link rel="shortcut icon" href="assets/images/logo.png" type="image/png">
  <link rel="stylesheet" href="style.css">

  <style>
    input, button, select { margin:4px 0; padding:6px; font-size:14px; }
    .section-box { background:#fff; border:1px solid #aaa; padding:15px; margin-bottom:20px; }
    .user-card { border:1px solid #ccc; background:#fff; padding:15px; margin-bottom:15px; position:relative; }
    .user-select { position:absolute; top:10px; right:10px; }
    .admin-controls { display:grid; gap:6px; margin-top:10px; }
    .admin-controls div { display:flex; gap:10px; align-items:center; }
    .admin-controls label { width:120px; font-weight:bold; }
    .flags { font-size:0.9em; color:#666; margin-top:5px; }
    #auditLog { max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#fafafa; }
  </style>
</head>
<body>
  <div id="bitsDisplay">Bits: <span id="bitCountTop">0</span></div>

  <div class="page-wrapper">
    <header>
      <a href="index.html" class="site-logo-link"><img src="assets/images/logo.png" class="site-logo" alt="Logo"></a>
      <nav>
        <a href="index.html">Home</a><a href="games.html">Games</a><a href="profile.html">Profile</a>
        <a href="people.html">People</a><a href="shop.html">Shop</a>
        <a href="admin.html" id="adminBtn" style="display:none;">Admin</a>
        <a href="login.html" id="loginLink">Login</a><a href="#" id="logoutLink" style="display:none;" onclick="logout()">Logout</a>
      </nav>
    </header>

    <main>
      <h2>Owner Control Center</h2>

      <!-- Broadcast to All -->
      <div class="section-box">
        <h3>Broadcast Message</h3>
        <input id="broadcastInput" placeholder="Message…">
        <button onclick="broadcastAll()">Send</button>
        <button onclick="clearBroadcast()">Clear</button>
      </div>

      <!-- Targeted Alert -->
      <div class="section-box">
        <h3>Targeted Alert</h3>
        <select id="alertUserSelect"></select>
        <input id="alertInput" placeholder="Alert…">
        <button onclick="sendAlert()">Send</button>
        <button onclick="clearAllAlerts()">Clear All</button>
      </div>

      <!-- NEW: Ban Log Tools -->
      <div class="section-box">
        <h3>Ban Log Tools</h3>
        <button onclick="exportBanLog()">Export Ban Logs</button>
        <button onclick="massUnbanExpired()">Unban All Expired</button>
        <button onclick="viewFiltered('banned')">Show Banned Only</button>
        <button onclick="viewFiltered('active')">Show Active Only</button>
        <button onclick="viewFiltered('all')">Show All Users</button>
      </div>

      <!-- User Search & List -->
      <input type="text" id="searchBar" placeholder="Search users…" style="width:100%;padding:8px;margin:10px 0;" oninput="renderUserList()">
      <div id="adminUsers">Loading users…</div>

      <!-- Audit Log -->
      <div class="section-box">
        <h3>Audit Log</h3>
        <button onclick="clearAuditLog()">Clear Logs</button>
        <div id="auditLog">Loading…</div>
      </div>
    </main>

    <footer>© 2025 PixelGame.</footer>
  </div>

  <script>
  const OWNER="Nova";
  let currentFilter="all";

  /* Utility */
  function logout() {
    localStorage.removeItem("profileUsername");
    localStorage.removeItem("profileBio");
    updateNavLinks();
    window.location.href="login.html";
  }
  function updateNavLinks() {
    const me=localStorage.getItem("profileUsername");
    document.getElementById("loginLink").style.display=me?"none":"inline";
    document.getElementById("logoutLink").style.display=me?"inline":"none";
    document.getElementById("adminBtn").style.display=(me===OWNER)?"inline":"none";
  }
  function updateBitsDisplay() {
    const ud=JSON.parse(localStorage.getItem("userData"))||{}, me=localStorage.getItem("profileUsername");
    if(ud[me]) document.getElementById("bitCountTop").innerText=ud[me].bits||0;
  }
  function logAction(action,target,details="") {
    const logs=JSON.parse(localStorage.getItem("adminAuditLog"))||[];
    logs.unshift({time:new Date().toLocaleString(),admin:OWNER,action,target,details});
    localStorage.setItem("adminAuditLog",JSON.stringify(logs));
    renderAuditLog();
  }

  /* Broadcast & Alerts */
  function broadcastAll(){
    const msg=document.getElementById("broadcastInput").value.trim();
    if(!msg) return alert("Enter message");
    localStorage.setItem("broadcastMessage",msg);
    logAction("Broadcast","ALL",msg);
    alert("Broadcast set");
  }
  function clearBroadcast(){
    localStorage.removeItem("broadcastMessage");
    logAction("ClearBroadcast","ALL");
    alert("Broadcast cleared");
  }
  function sendAlert(){
    const user=document.getElementById("alertUserSelect").value,msg=document.getElementById("alertInput").value.trim();
    if(!user||!msg) return alert("Select user & message");
    const a=JSON.parse(localStorage.getItem("userAlerts"))||{};
    (a[user]=a[user]||[]).push({by:OWNER,time:new Date().toLocaleString(),msg});
    localStorage.setItem("userAlerts",JSON.stringify(a));
    logAction("Alert",user,msg);
    alert("Alert queued");
  }
  function clearAllAlerts(){
    localStorage.removeItem("userAlerts");
    logAction("ClearAlerts","ALL");
    alert("Alerts cleared");
  }

  /* Maintenance Mode */
  function toggleMaintenance(){
    const m=localStorage.getItem("maintenanceMode")==="true";
    localStorage.setItem("maintenanceMode",(!m).toString());
    document.getElementById("maintenanceBtn").innerText=m?"Enable Maintenance":"Disable Maintenance";
    logAction("Maintenance",m?"Disabled":"Enabled");
    alert("Maintenance "+(m?"disabled":"enabled"));
  }

  /* Backup & Restore */
  function exportData(){
    const data=JSON.stringify(JSON.parse(localStorage.getItem("userData")||"{}"));
    const a=document.createElement("a");
    a.href="data:application/json,"+encodeURIComponent(data);
    a.download="userdata.json"; a.click();
    logAction("ExportData","ALL");
  }
  function importData(){
    const j=prompt("Paste JSON to import:");
    if(!j) return; try{JSON.parse(j);localStorage.setItem("userData",j);alert("Imported");logAction("ImportData","ALL");renderUserList();}catch{alert("Invalid JSON");}
  }

  /* Ban Log Tools */
  function exportBanLog() {
    const logs=JSON.parse(localStorage.getItem("adminAuditLog"))||[];
    const banLogs=logs.filter(l=>l.action==="Banned"||l.action==="Unbanned");
    if(!banLogs.length) return alert("No ban logs");
    let csv="Time,Admin,Action,User,Details\n";
    banLogs.forEach(l=>{csv+=`"${l.time}","${l.admin}","${l.action}","${l.target}","${l.details.replace(/"/g,'""')}"\n`;});
    const a=document.createElement("a");
    a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
    a.download="ban_logs.csv"; a.click();
  }
  function massUnbanExpired() {
    const ud=JSON.parse(localStorage.getItem("userData"))||{},now=Date.now();
    let c=0;
    for(const u in ud){
      if(ud[u].isBanned&&ud[u].banExpires&&now>ud[u].banExpires){
        ud[u].isBanned=false; delete ud[u].banReason; delete ud[u].banExpires;
        logAction("AutoUnbanned",u); c++;
      }
    }
    localStorage.setItem("userData",JSON.stringify(ud));
    renderUserList(); alert(`Unbanned ${c} user(s).`);
  }
  function viewFiltered(criteria){
    currentFilter=criteria; renderUserList();
  }

  /* Per-User Actions */
  function togglePassword(u){const f=document.getElementById(`newPass-${u}`);f.type=f.type==="password"?"text":"password";}
  function toggleAdmin(u){const d=JSON.parse(localStorage.getItem("userData"))||{};d[u].isAdmin=!d[u].isAdmin;localStorage.setItem("userData",JSON.stringify(d));logAction(d[u].isAdmin?"Promoted":"Demoted",u);}
  function toggleLock(u){const d=JSON.parse(localStorage.getItem("userData"))||{},x=d[u],r=prompt("Lock reason:")||"No reason",m=prompt("Minutes to lock:"),e=(m&&!isNaN(m))?Date.now()+parseInt(m)*60000:null;x.isLocked=!x.isLocked;x.isLocked?(x.lockReason=r,x.lockExpires=e,alert(`${u} locked`),logAction("Locked",u,r)):(delete x.lockReason,delete x.lockExpires,alert(`${u} unlocked`),logAction("Unlocked",u));localStorage.setItem("userData",JSON.stringify(d));}
  function banUser(u,r,e){const d=JSON.parse(localStorage.getItem("userData"))||{},x=d[u];x.isBanned=true;x.banReason=r;x.banExpires=e;localStorage.setItem("userData",JSON.stringify(d));logAction("Banned",u,r);}
  function unbanUser(u){const d=JSON.parse(localStorage.getItem("userData"))||{},x=d[u];x.isBanned=false;delete x.banReason;delete x.banExpires;localStorage.setItem("userData",JSON.stringify(d));logAction("Unbanned",u);}
  function toggleBan(u){const d=JSON.parse(localStorage.getItem("userData"))||{};d[u].isBanned?unbanUser(u):banUser(u,"No reason",null);renderUserList();}
  function toggleMute(u){const d=JSON.parse(localStorage.getItem("userData"))||{};d[u].isMuted=!d[u].isMuted;localStorage.setItem("userData",JSON.stringify(d));logAction(d[u].isMuted?"Muted":"Unmuted",u);}
  function toggleForceReset(u){const d=JSON.parse(localStorage.getItem("userData"))||{};d[u].forceReset=!d[u].forceReset;localStorage.setItem("userData",JSON.stringify(d));logAction(d[u].forceReset?"ForcePwdResetOn":"ForcePwdResetOff",u);}
  function resetStats(u){if(!confirm(`Reset stats for ${u}?`))return;const d=JSON.parse(localStorage.getItem("userData"))||{},x=d[u];x.bits=0; x.bio="";x.friends=[];x.shirtsEquipped=null;x.pantsEquipped=null;localStorage.setItem("userData",JSON.stringify(d));logAction("ResetStats",u);}
  function applyChanges(oldU){const d=JSON.parse(localStorage.getItem("userData"))||{};const nn=document.getElementById(`newName-${oldU}`).value.trim(),nb=document.getElementById(`newBio-${oldU}`).value,nbt=parseInt(document.getElementById(`newBits-${oldU}`).value)||0,np=document.getElementById(`newPass-${oldU}`).value; if(nn!==oldU&&d[nn])return alert("Name taken");const u=d[oldU];delete d[oldU];u.username=nn;u.bio=nb;u.bits=nbt;u.password=np;d[nn]=u;for(const x in d){const f=d[x].friends||[],i=f.indexOf(oldU);if(i!==-1){f[i]=nn;d[x].friends=f;}}localStorage.setItem("userData",JSON.stringify(d));logAction("Edited",oldU,`→${nn}`);}
  function deleteUser(u){if(!confirm(`Delete ${u}?`))return;const d=JSON.parse(localStorage.getItem("userData"))||{};delete d[u];for(const x in d){d[x].friends=(d[x].friends||[]).filter(f=>f!==u);}localStorage.setItem("userData",JSON.stringify(d));logAction("Deleted",u);}

  /* Render Users */
  function renderUserList(){
    const ud=JSON.parse(localStorage.getItem("userData"))||{},s=document.getElementById("searchBar").value.toLowerCase(),ct=document.getElementById("adminUsers"),now=Date.now();
    ct.innerHTML=""; document.getElementById("alertUserSelect").innerHTML="<option value=''>Select…</option>";
    for(const u in ud){
      if(!u.toLowerCase().includes(s)) continue;
      const x=ud[u];
      if(x.isLocked&&x.lockExpires&&now>x.lockExpires) delete x.isLocked,x.lockReason,x.lockExpires;
      if(x.isBanned&&x.banExpires&&now>x.banExpires) delete x.isBanned,x.banReason,x.banExpires;
      if(currentFilter==="banned"&&!x.isBanned) continue;
      if(currentFilter==="active"&&x.isBanned) continue;
      const opt=document.createElement("option");opt.value=u;opt.innerText=u;document.getElementById("alertUserSelect").appendChild(opt);
      const flags=[x.isAdmin?"Admin":"User", x.isLocked?"Locked":"Unlocked", x.isLocked&&x.lockExpires?`${Math.ceil((x.lockExpires-now)/60000)}m lock left`:"", x.isBanned?"Banned":"Active", x.isBanned&&x.banExpires?`${Math.ceil((x.banExpires-now)/60000)}m ban left`:"", x.isMuted?"Muted":"", x.forceReset?"PwdReset":"", `LastLogin:${x.lastLogin?new Date(x.lastLogin).toLocaleString():"–"}`].filter(Boolean).join(" | ");
      ct.innerHTML+=`
        <div class="user-card">
          <input type="checkbox" class="user-select" value="${u}">
          <strong>${u}</strong>
          <div class="flags">${flags}</div>
          ${x.isBanned?`<div style="color:red"><b>Reason:</b>${x.banReason}</div>`:""}
          ${x.isLocked?`<div style="color:orange"><b>Lock:</b>${x.lockReason}</div>`:""}
          <div class="admin-controls">
            <div><label>Name:</label><input id="newName-${u}" value="${u}"></div>
            <div><label>Bio:</label><input id="newBio-${u}" value="${x.bio||""}"></div>
            <div><label>Bits:</label><input type="number" id="newBits-${u}" value="${x.bits||0}"></div>
            <div><label>Password:</label><input type="password" id="newPass-${u}" value="${x.password||""}"><button onclick="togglePassword('${u}')">👁️</button></div>
            <div>
              <button onclick="toggleAdmin('${u}')">${x.isAdmin?"Demote":"Promote"} Admin</button>
              <button onclick="toggleLock('${u}')">${x.isLocked?"Unlock":"Lock"} Acc</button>
              <button onclick="toggleBan('${u}')">${x.isBanned?"Unban":"Ban"} User</button>
              <button onclick="toggleMute('${u}')">${x.isMuted?"Unmute":"Mute"}</button>
              <button onclick="toggleForceReset('${u}')">${x.forceReset?"ClrPwdRes":"ForcePwdRes"}</button>
              <button onclick="resetStats('${u}')">Reset Stats</button>
              <button onclick="applyChanges('${u}')">Save</button>
              <button onclick="deleteUser('${u}')">Delete</button>
            </div>
          </div>
        </div>`;
    }
  }

  /* On Load */
  document.addEventListener("DOMContentLoaded",()=>{
    const me=localStorage.getItem("profileUsername");
    if(me!==OWNER){
      document.body.innerHTML="<div style='padding:30px;'><h2>Access Denied</h2></div>";
      return;
    }
    updateNavLinks(); updateBitsDisplay(); renderUserList(); renderAuditLog();
    // Set Maintenance button text
    document.getElementById("maintenanceBtn").innerText = localStorage.getItem("maintenanceMode")==="true" ? "Disable Maintenance" : "Enable Maintenance";
  });
  </script>
</body>
</html>
