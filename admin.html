<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PixelGame - Admin Panel</title>

  <link rel="icon" href="assets/images/logo.png" type="image/png">
  <link rel="shortcut icon" href="assets/images/logo.png" type="image/png">
  <link rel="stylesheet" href="style.css">

  <style>
    input, button {
      margin: 4px 0;
      padding: 6px;
      font-size: 14px;
    }

    .user-card {
      background: #fff;
      border: 1px solid #aaa;
      padding: 15px;
      margin-bottom: 20px;
    }

    .admin-controls {
      margin-top: 10px;
      display: grid;
      gap: 6px;
    }

    .admin-controls div {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .admin-controls label {
      width: 120px;
      font-weight: bold;
    }

    .flags {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="bitsDisplay">Bits: <span id="bitCountTop">0</span></div>

  <div class="page-wrapper">
    <header>
      <a href="index.html" class="site-logo-link">
        <img src="assets/images/logo.png" alt="PixelGame" class="site-logo">
      </a>
      <nav>
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="profile.html">Profile</a>
        <a href="people.html">People</a>
        <a href="shop.html">Shop</a>
        <a href="admin.html" id="adminBtn" style="display: none;">Admin Panel</a>
        <a href="login.html" id="loginLink">Login</a>
        <a href="#" id="logoutLink" style="display: none;" onclick="logout()">Logout</a>
      </nav>
    </header>

    <main>
      <h2>Admin Panel - Owner Control</h2>
      <input type="text" id="searchBar" placeholder="Search users..." oninput="renderUserList()" style="width: 100%; padding: 10px; margin: 15px 0;">
      <div id="adminUsers">Loading users...</div>
    </main>

    <footer>¬© 2025 PixelGame.</footer>

  <script>
    const currentAdmin = "Nova";

    function logout() {
      localStorage.removeItem("profileUsername");
      localStorage.removeItem("profileBio");
      updateNavLinks();
      window.location.href = "login.html";
    }

    function updateNavLinks() {
      const username = localStorage.getItem("profileUsername");
      const isAdmin = username === currentAdmin;
      document.getElementById("loginLink").style.display = username ? "none" : "inline";
      document.getElementById("logoutLink").style.display = username ? "inline" : "none";
      const adminBtn = document.getElementById("adminBtn");
      if (adminBtn) adminBtn.style.display = isAdmin ? "inline" : "none";
    }

    function updateBitsDisplay() {
      const userData = JSON.parse(localStorage.getItem("userData")) || {};
      const username = localStorage.getItem("profileUsername");
      if (!username || !userData[username]) return;
      const bits = userData[username].bits ?? 0;
      document.getElementById("bitCountTop").innerText = bits;
    }

    function togglePassword(username) {
      const input = document.getElementById(`newPass-${username}`);
      input.type = input.type === "password" ? "text" : "password";
    }

    function toggleAdmin(username) {
      const userData = JSON.parse(localStorage.getItem("userData")) || {};
      userData[username].isAdmin = !userData[username].isAdmin;
      localStorage.setItem("userData", JSON.stringify(userData));
      renderUserList();
    }

    function toggleBan(username) {
      const userData = JSON.parse(localStorage.getItem("userData")) || {};
      const user = userData[username];
      if (!user) return;

      if (!user.isBanned) {
        const reason = prompt(`Enter ban reason for "${username}":`) || "No reason provided.";
        const duration = prompt("How many minutes to ban for? Leave empty for permanent:");
        let expiresAt = null;

        if (duration && !isNaN(duration)) {
          const minutes = parseInt(duration);
          expiresAt = Date.now() + minutes * 60000;
        }

        user.isBanned = true;
        user.banReason = reason;
        user.banExpires = expiresAt;

        alert(`${username} has been banned ${expiresAt ? `for ${duration} minutes` : "permanently"}.`);
      } else {
        user.isBanned = false;
        delete user.banReason;
        delete user.banExpires;
        alert(`${username} has been unbanned.`);
      }

      localStorage.setItem("userData", JSON.stringify(userData));
      renderUserList();
    }

    function applyChanges(oldUsername) {
      const userData = JSON.parse(localStorage.getItem("userData")) || {};
      const newName = document.getElementById(`newName-${oldUsername}`).value.trim();
      const newBio = document.getElementById(`newBio-${oldUsername}`).value;
      const newBits = parseInt(document.getElementById(`newBits-${oldUsername}`).value) || 0;
      const newPass = document.getElementById(`newPass-${oldUsername}`).value;

      if (newName !== oldUsername && userData[newName]) {
        alert("Username already exists.");
        return;
      }

      const user = userData[oldUsername];
      delete userData[oldUsername];
      user.username = newName;
      user.bio = newBio;
      user.bits = newBits;
      user.password = newPass;
      userData[newName] = user;

      for (const u in userData) {
        const friends = userData[u].friends || [];
        const index = friends.indexOf(oldUsername);
        if (index !== -1) {
          friends.splice(index, 1, newName);
          userData[u].friends = friends;
        }
      }

      localStorage.setItem("userData", JSON.stringify(userData));
      renderUserList();
    }

    function deleteUser(username) {
      if (!confirm(`Delete "${username}"? This cannot be undone.`)) return;
      const userData = JSON.parse(localStorage.getItem("userData")) || {};
      delete userData[username];
      for (const u in userData) {
        userData[u].friends = (userData[u].friends || []).filter(f => f !== username);
      }
      localStorage.setItem("userData", JSON.stringify(userData));
      renderUserList();
    }

    function renderUserList() {
      const userData = JSON.parse(localStorage.getItem("userData")) || {};
      const search = document.getElementById("searchBar").value.toLowerCase();
      const container = document.getElementById("adminUsers");
      container.innerHTML = "";

      const now = Date.now();

      for (const username in userData) {
        const user = userData[username];

        // Auto-unban expired temp bans
        if (user.isBanned && user.banExpires && now > user.banExpires) {
          user.isBanned = false;
          delete user.banReason;
          delete user.banExpires;
        }

        if (!username.toLowerCase().includes(search)) continue;

        const flags = [
          user.isAdmin ? "Admin" : "User",
          user.isBanned ? "Banned" : "Active",
          user.banExpires ? `‚è± until ${new Date(user.banExpires).toLocaleTimeString()}` : ""
        ].filter(Boolean).join(" | ");

        container.innerHTML += `
          <div class="user-card">
            <strong>${username}</strong>
            <div class="flags">${flags}</div>
            ${user.isBanned ? `<div style="color: red;"><b>Reason:</b> ${user.banReason || "None"}</div>` : ""}
            <div class="admin-controls">
              <div><label>Username:</label><input type="text" id="newName-${username}" value="${username}"></div>
              <div><label>Bio:</label><input type="text" id="newBio-${username}" value="${user.bio || ""}"></div>
              <div><label>Bits:</label><input type="number" id="newBits-${username}" value="${user.bits ?? 0}"></div>
              <div>
                <label>Password:</label>
                <input type="password" id="newPass-${username}" value="${user.password || ""}">
                <button onclick="togglePassword('${username}')">üëÅÔ∏è</button>
              </div>
              <div>
                <button onclick="toggleAdmin('${username}')">${user.isAdmin ? "Demote" : "Promote"} Admin</button>
                <button onclick="toggleBan('${username}')">${user.isBanned ? "Unban" : "Ban"} User</button>
                <button onclick="applyChanges('${username}')">‚úÖ Save</button>
                <button onclick="deleteUser('${username}')">üóëÔ∏è Delete</button>
              </div>
            </div>
          </div>
        `;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const username = localStorage.getItem("profileUsername");
      if (username !== currentAdmin) {
        document.body.innerHTML = "<div style='padding: 30px;'><h2>Access Denied</h2><p>This page is for the Owner (Nova) only.</p></div>";
        return;
      }
      updateNavLinks();
      updateBitsDisplay();
      renderUserList();
    });
  </script>
</body>
</html>
