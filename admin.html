<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PixelGame – Admin Panel</title>
  <link rel="icon" href="assets/images/logo.png" type="image/png">
  <link rel="shortcut icon" href="assets/images/logo.png" type="image/png">
  <link rel="stylesheet" href="style.css">
  <style>
    input, button, select { margin:4px 0; padding:6px; font-size:14px; }
    .section-box { background:#fff; border:1px solid #aaa; padding:15px; margin-bottom:20px; }
    .user-card { border:1px solid #ccc; background:#fff; padding:15px; margin-bottom:15px; }
    .admin-controls { display:grid; gap:6px; margin-top:10px; }
    .admin-controls div { display:flex; gap:10px; align-items:center; }
    .admin-controls label { width:120px; font-weight:bold; }
    .flags { font-size:0.9em; color:#666; margin-top:5px; }
    #auditLog { background:#fff; border:1px solid #aaa; padding:15px; max-height:200px; overflow-y:auto; }
  </style>
</head>
<body>
  <div id="bitsDisplay">Bits: <span id="bitCountTop">0</span></div>
  <div class="page-wrapper">
    <header>
      <a href="index.html" class="site-logo-link">
        <img src="assets/images/logo.png" class="site-logo" alt="PixelGame">
      </a>
      <nav>
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="profile.html">Profile</a>
        <a href="people.html">People</a>
        <a href="shop.html">Shop</a>
        <a href="admin.html" id="adminBtn" style="display:none;">Admin Panel</a>
        <a href="login.html" id="loginLink">Login</a>
        <a href="#" id="logoutLink" style="display:none;" onclick="logout()">Logout</a>
      </nav>
    </header>

    <main>
      <h2>Admin Panel – Owner Control</h2>

      <!-- Broadcast -->
      <div class="section-box">
        <h3>Broadcast Message</h3>
        <input type="text" id="broadcastInput" placeholder="Your broadcast…">
        <button onclick="broadcastAll()">Send to All</button>
        <button onclick="clearBroadcast()">Clear Broadcast</button>
      </div>

      <!-- Targeted Alert -->
      <div class="section-box">
        <h3>Targeted Alert</h3>
        <select id="alertUserSelect"></select>
        <input type="text" id="alertInput" placeholder="Alert message…">
        <button onclick="sendAlert()">Send Alert</button>
        <button onclick="clearAlerts()">Clear All Alerts</button>
      </div>

      <!-- Maintenance Mode -->
      <div class="section-box">
        <h3>Maintenance Mode</h3>
        <button id="maintenanceToggle" onclick="toggleMaintenance()">Toggle Maintenance</button>
        <span id="maintenanceStatus"></span>
      </div>

      <!-- Filters -->
      <div class="section-box">
        <h3>Filters</h3>
        <label><input type="checkbox" id="filterAdmins" checked onchange="renderUserList()"> Show Admins</label>
        <label><input type="checkbox" id="filterBanned" checked onchange="renderUserList()"> Show Banned</label>
        <label><input type="checkbox" id="filterLocked" checked onchange="renderUserList()"> Show Locked</label>
        <label><input type="checkbox" id="filterActive" checked onchange="renderUserList()"> Show Active</label>
        <button onclick="clearAuditLog()">Clear Audit Log</button>
      </div>

      <!-- User Management -->
      <input type="text" id="searchBar" placeholder="Search users…" style="width:100%;padding:10px;margin:15px 0;" oninput="renderUserList()">
      <div id="adminUsers">Loading users…</div>

      <!-- Audit Log -->
      <div class="section-box">
        <h3>Audit Log</h3>
        <div id="auditLog">Loading logs…</div>
      </div>
    </main>

    <footer>© 2025 PixelGame.</footer>
  </div>

  <script>
    const OWNER = "Nova";

    // Basic utilities
    function logout(){
      localStorage.removeItem("profileUsername");
      localStorage.removeItem("profileBio");
      updateNavLinks();
      window.location.href="login.html";
    }
    function updateNavLinks(){
      const me = localStorage.getItem("profileUsername");
      document.getElementById("loginLink").style.display=me?"none":"inline";
      document.getElementById("logoutLink").style.display=me?"inline":"none";
      document.getElementById("adminBtn").style.display=(me===OWNER)?"inline":"none";
    }
    function updateBitsDisplay(){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const me=localStorage.getItem("profileUsername");
      if(ud[me]) document.getElementById("bitCountTop").innerText=ud[me].bits||0;
    }

    // Audit log
    function logAction(action,target,details=""){
      const logs=JSON.parse(localStorage.getItem("adminAuditLog"))||[];
      logs.unshift({time:new Date().toLocaleString(),admin:OWNER,action,target,details});
      localStorage.setItem("adminAuditLog",JSON.stringify(logs));
      renderAuditLog();
    }
    function renderAuditLog(){
      const logs=JSON.parse(localStorage.getItem("adminAuditLog"))||[];
      document.getElementById("auditLog").innerHTML=
        logs.slice(0,20).map(l=>`[${l.time}] ${l.admin} ${l.action} ${l.target} ${l.details}`).join("<br>");
    }
    function clearAuditLog(){
      localStorage.removeItem("adminAuditLog");
      renderAuditLog();
    }

    // Broadcast
    function broadcastAll(){
      const msg=document.getElementById("broadcastInput").value.trim();
      if(!msg) return alert("Type a message.");
      localStorage.setItem("broadcastMessage",msg);
      logAction("Broadcast","ALL",msg);
      alert("Broadcast queued.");
    }
    function clearBroadcast(){
      localStorage.removeItem("broadcastMessage");
      logAction("Clear Broadcast","ALL");
      alert("Broadcast cleared.");
    }

    // Alerts
    function sendAlert(){
      const user=document.getElementById("alertUserSelect").value;
      const msg=document.getElementById("alertInput").value.trim();
      if(!user||!msg) return alert("Select user & message.");
      const alerts=JSON.parse(localStorage.getItem("userAlerts"))||{};
      alerts[user]=alerts[user]||[];
      alerts[user].push({by:OWNER,time:new Date().toLocaleString(),msg});
      localStorage.setItem("userAlerts",JSON.stringify(alerts));
      logAction("Alert",user,msg);
      alert("Alert sent.");
    }
    function clearAlerts(){
      localStorage.removeItem("userAlerts");
      logAction("Clear Alerts","ALL");
      alert("Alerts cleared.");
    }

    // Maintenance Mode
    function toggleMaintenance(){
      const m=localStorage.getItem("maintenanceMode")==="true";
      localStorage.setItem("maintenanceMode",(!m).toString());
      logAction(m?"Disable Maintenance":"Enable Maintenance","ALL");
      updateMaintenanceUI();
    }
    function updateMaintenanceUI(){
      const m=localStorage.getItem("maintenanceMode")==="true";
      document.getElementById("maintenanceStatus").innerText=m?"ON":"OFF";
      document.getElementById("maintenanceToggle").innerText=m?"Disable":"Enable";
    }

    // User actions: password toggle, admin, lock, ban, reset, delete
    function togglePassword(u){const f=document.getElementById(`newPass-${u}`);f.type=f.type==="password"?"text":"password";}
    function toggleAdmin(u){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      ud[u].isAdmin=!ud[u].isAdmin;
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction(ud[u].isAdmin?"Promote Admin":"Demote Admin",u);
      renderUserList();
    }
    function toggleLock(u){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const user=ud[u];
      if(!user.isLocked){
        const reason=prompt(`Reason to lock ${u}:`)||"No reason";
        const dur=prompt("Minutes to lock (blank=perm):");
        let exp=null; if(dur&&!isNaN(dur)) exp=Date.now()+parseInt(dur)*60000;
        user.isLocked=true;user.lockReason=reason;user.lockExpires=exp;
        alert(`${u} locked.`);
        logAction("Lock",u,reason+(exp?` until ${new Date(exp).toLocaleString()}`:""));
      } else {
        user.isLocked=false;delete user.lockReason;delete user.lockExpires;
        alert(`${u} unlocked.`);
        logAction("Unlock",u);
      }
      localStorage.setItem("userData",JSON.stringify(ud));
      renderUserList();
    }
    function toggleBan(u){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const user=ud[u];
      if(!user.isBanned){
        const reason=prompt(`Ban reason:`, "")||"No reason";
        const dur=prompt("Minutes to ban (blank=perm):");
        let exp=null; if(dur&&!isNaN(dur)) exp=Date.now()+parseInt(dur)*60000;
        user.isBanned=true;user.banReason=reason;user.banExpires=exp;
        alert(`${u} banned.`);
        logAction("Ban",u,reason+(exp?` until ${new Date(exp).toLocaleString()}`:""));
      } else {
        user.isBanned=false;delete user.banReason;delete user.banExpires;
        alert(`${u} unbanned.`);
        logAction("Unban",u);
      }
      localStorage.setItem("userData",JSON.stringify(ud));
      renderUserList();
    }
    function resetStats(u){
      if(!confirm(`Reset stats for ${u}?`)) return;
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const user=ud[u];user.bits=0;user.bio="";user.friends=[];user.shirtsEquipped=null;user.pantsEquipped=null;
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction("ResetStats",u);
      renderUserList();
    }
    function applyChanges(oldU){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const newName=document.getElementById(`newName-${oldU}`).value.trim();
      const newBio=document.getElementById(`newBio-${oldU}`).value;
      const newBits=parseInt(document.getElementById(`newBits-${oldU}`).value)||0;
      const newPass=document.getElementById(`newPass-${oldU}`).value;
      if(newName!==oldU&&ud[newName]) return alert("Name in use.");
      const user=ud[oldU];delete ud[oldU];
      user.username=newName;user.bio=newBio;user.bits=newBits;user.password=newPass;
      ud[newName]=user;
      for(const x in ud){
        const f=ud[x].friends||[];
        const i=f.indexOf(oldU);
        if(i!==-1){f.splice(i,1,newName);ud[x].friends=f;}
      }
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction("EditUser",newName);
      renderUserList();
    }
    function deleteUser(u){
      if(!confirm(`Delete ${u}?`)) return;
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      delete ud[u];
      for(const x in ud) ud[x].friends=(ud[x].friends||[]).filter(f=>f!==u);
      localStorage.setItem("userData",JSON.stringify(ud));
      logAction("DeleteUser",u);
      renderUserList();
    }

    // Render users with filters
    function renderUserList(){
      const ud=JSON.parse(localStorage.getItem("userData"))||{};
      const s=document.getElementById("searchBar").value.toLowerCase();
      const showA=document.getElementById("filterAdmins").checked;
      const showB=document.getElementById("filterBanned").checked;
      const showL=document.getElementById("filterLocked").checked;
      const showC=document.getElementById("filterActive").checked;
      const ct=document.getElementById("adminUsers");
      ct.innerHTML=""; document.getElementById("alertUserSelect").innerHTML="<option value=''>Select…</option>";
      const now=Date.now();

      for(const u in ud){
        const user=ud[u];
        if(!u.toLowerCase().includes(s)) continue;
        // auto-expire
        if(user.isLocked&&user.lockExpires&&now>user.lockExpires){user.isLocked=false;delete user.lockReason;delete user.lockExpires;}
        if(user.isBanned&&user.banExpires&&now>user.banExpires){user.isBanned=false;delete user.banReason;delete user.banExpires;}
        // filter
        if(user.isAdmin && !showA) continue
